<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:Maui.Prometheus.Viewer.Pages.Controls"
             xmlns:pageModels="clr-namespace:Maui.Prometheus.Viewer.PageModels"
             x:Class="Maui.Prometheus.Viewer.Pages.SystemMetricsPage"
             x:DataType="pageModels:SystemMetricsViewModel"
             Title="System Metrics">

    <Grid RowDefinitions="Auto,*" Padding="10">

        <!-- Header with connection status -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Padding="10" Margin="0,0,0,10">
            <Label Grid.Column="0" 
                   Text="{Binding ConnectionStatus}"
                   FontSize="14"
                   VerticalOptions="Center"/>

            <HorizontalStackLayout Grid.Column="1" Spacing="10">
                <ActivityIndicator IsRunning="{Binding IsBusy}" 
                                   IsVisible="{Binding IsBusy}"
                                   WidthRequest="20"
                                   HeightRequest="20"/>
                <Label Text="{Binding LastUpdated, StringFormat='Updated: {0}'}"
                       FontSize="12"
                       TextColor="Gray"
                       VerticalOptions="Center"/>
                <Button Text="â†»" 
                        Command="{Binding RefreshCommand}"
                        WidthRequest="40"
                        HeightRequest="40"/>
            </HorizontalStackLayout>
        </Grid>

        <!-- Content -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="15">

                <!-- Current Metrics Cards -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                    <controls:MetricCard Grid.Column="0"
                                       Title="Memory Usage"
                                       Value="{Binding MemoryUsageMB, StringFormat='{0:F1}'}"
                                       Unit="MB"
                                       CardColor="#00BCD4"/>

                    <controls:MetricCard Grid.Column="1"
                                       Title="GC Rate"
                                       Value="{Binding GcRate, StringFormat='{0:F2}'}"
                                       Unit="ops/s"
                                       CardColor="#FF5722"/>
                </Grid>

                <!-- Memory Statistics Summary -->
                <Border Style="{StaticResource CardBorder}" BackgroundColor="#1E1E1E">
                    <Grid ColumnDefinitions="*,*,*" Padding="15" ColumnSpacing="10">
                        <VerticalStackLayout Grid.Column="0" Spacing="5">
                            <Label Text="MIN" 
                                   FontSize="10" 
                                   TextColor="Gray"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding MemoryMin, StringFormat='{0:F1} MB'}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#4CAF50"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1" Spacing="5">
                            <Label Text="AVG" 
                                   FontSize="10" 
                                   TextColor="Gray"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding MemoryAvg, StringFormat='{0:F1} MB'}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#2196F3"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="2" Spacing="5">
                            <Label Text="MAX" 
                                   FontSize="10" 
                                   TextColor="Gray"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding MemoryMax, StringFormat='{0:F1} MB'}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#FF9800"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <!-- Memory Usage Chart -->
                <Border Style="{StaticResource CardBorder}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Memory Usage Over Time" 
                               FontSize="16" 
                               FontAttributes="Bold"/>
                        <Label Text="{Binding MemoryUsageFormatted, StringFormat='Current: {0}'}"
                               FontSize="12"
                               TextColor="Gray"/>
                        <controls:SimpleLineChart DataPoints="{Binding MemoryUsageData}"
                                                  HeightRequest="300"/>
                        <Label Text="ðŸ“Š Last 15 minutes" 
                               FontSize="10" 
                               TextColor="Gray"
                               HorizontalOptions="End"
                               Margin="0,5,0,0"/>
                    </VerticalStackLayout>
                </Border>

                <!-- GC Collections Chart -->
                <Border Style="{StaticResource CardBorder}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Garbage Collection Rate" 
                               FontSize="16" 
                               FontAttributes="Bold"/>
                        <Label Text="Collections per second by generation"
                               FontSize="12"
                               TextColor="Gray"/>
                        <controls:SimpleLineChart DataPoints="{Binding GcCollectionsData}"
                                                  HeightRequest="300"/>
                        <Label Text="ðŸ“Š Last 15 minutes" 
                               FontSize="10" 
                               TextColor="Gray"
                               HorizontalOptions="End"
                               Margin="0,5,0,0"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Info Section -->
                <Border Style="{StaticResource CardBorder}" BackgroundColor="#263238">
                    <VerticalStackLayout Spacing="10" Padding="10">
                        <Label Text="â„¹ï¸ System Metrics Information" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="#00BCD4"/>
                        <Label FontSize="12" TextColor="#B0BEC5">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="â€¢ Memory Usage: " FontAttributes="Bold"/>
                                    <Span Text="Process working set in megabytes. Shows how much RAM the application is currently using."/>
                                    <Span Text="&#10;&#10;â€¢ GC Rate: " FontAttributes="Bold"/>
                                    <Span Text="Garbage collections per second, broken down by generation. Higher rates may indicate memory pressure."/>
                                    <Span Text="&#10;&#10;â€¢ Gen 0: " FontAttributes="Bold"/>
                                    <Span Text="Short-lived objects (most frequent, least expensive)"/>
                                    <Span Text="&#10;â€¢ Gen 1: " FontAttributes="Bold"/>
                                    <Span Text="Medium-lived objects (buffer between Gen 0 and Gen 2)"/>
                                    <Span Text="&#10;â€¢ Gen 2: " FontAttributes="Bold"/>
                                    <Span Text="Long-lived objects (least frequent, most expensive)"/>
                                    <Span Text="&#10;&#10;ðŸ’¡ Tip: " FontAttributes="Bold"/>
                                    <Span Text="High Gen 2 collection rates or consistently increasing memory may indicate a memory leak."/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </VerticalStackLayout>
                </Border>

                <!-- Health Status (Optional) -->
                <Border Style="{StaticResource CardBorder}" 
                        BackgroundColor="#1B5E20"
                        IsVisible="{Binding MemoryUsageMB, Converter={StaticResource LessThanConverter}, ConverterParameter=500}">
                    <HorizontalStackLayout Padding="15" Spacing="10">
                        <Label Text="âœ…" FontSize="20"/>
                        <Label Text="Memory usage is healthy" 
                               FontSize="14"
                               TextColor="White"
                               VerticalOptions="Center"/>
                    </HorizontalStackLayout>
                </Border>

                <Border Style="{StaticResource CardBorder}" 
                        BackgroundColor="#BF360C"
                        IsVisible="{Binding MemoryUsageMB, Converter={StaticResource GreaterThanConverter}, ConverterParameter=500}">
                    <HorizontalStackLayout Padding="15" Spacing="10">
                        <Label Text="âš ï¸" FontSize="20"/>
                        <VerticalStackLayout Spacing="5">
                            <Label Text="High memory usage detected" 
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                            <Label Text="{Binding MemoryUsageMB, StringFormat='Current: {0:F1} MB (threshold: 500 MB)'}"
                                   FontSize="12"
                                   TextColor="White"
                                   Opacity="0.8"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                </Border>

                <!-- Summary Statistics -->
                <Border Style="{StaticResource CardBorder}" BackgroundColor="#1E1E1E">
                    <VerticalStackLayout Spacing="10" Padding="15">
                        <Label Text="ðŸ“ˆ Summary Statistics" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="#FFC107"/>
                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" 
                              ColumnSpacing="10" RowSpacing="8">

                            <Label Grid.Row="0" Grid.Column="0" 
                                   Text="Current Memory:" 
                                   FontSize="12"
                                   TextColor="Gray"/>
                            <Label Grid.Row="0" Grid.Column="1" 
                                   Text="{Binding MemoryUsageFormatted}"
                                   FontSize="12"
                                   TextColor="White"
                                   HorizontalOptions="End"/>

                            <Label Grid.Row="1" Grid.Column="0" 
                                   Text="Memory Range:" 
                                   FontSize="12"
                                   TextColor="Gray"/>
                            <Label Grid.Row="1" Grid.Column="1" 
                                   Text="{Binding MemoryMin, StringFormat='{0:F1} - '}"
                                   FontSize="12"
                                   TextColor="White"
                                   HorizontalOptions="End">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding MemoryMin, StringFormat='{0:F1}'}" />
                                        <Span Text=" - " />
                                        <Span Text="{Binding MemoryMax, StringFormat='{0:F1} MB'}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>

                            <Label Grid.Row="2" Grid.Column="0" 
                                   Text="GC Collections/s:" 
                                   FontSize="12"
                                   TextColor="Gray"/>
                            <Label Grid.Row="2" Grid.Column="1" 
                                   Text="{Binding GcRate, StringFormat='{0:F2} ops/s'}"
                                   FontSize="12"
                                   TextColor="White"
                                   HorizontalOptions="End"/>

                            <Label Grid.Row="3" Grid.Column="0" 
                                   Text="Last Updated:" 
                                   FontSize="12"
                                   TextColor="Gray"/>
                            <Label Grid.Row="3" Grid.Column="1" 
                                   Text="{Binding LastUpdated}"
                                   FontSize="12"
                                   TextColor="White"
                                   HorizontalOptions="End"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Spacer for bottom padding -->
                <BoxView HeightRequest="20" Color="Transparent"/>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>
</ContentPage>